# Pre-commit / Post-commit Optimization Proposal

**Status:** PROPOSAL
**Created:** 2025-10-21
**Purpose:** Optimize commit workflow by separating validation from cleanup

## Problem Statement

Currently, pre-commit does both:
1. **Validation** (ensuring code is bug-free) ✅ Should stay
2. **Cleanup/Updates** (generating docs, updating timestamps) ⚠️ Should move

This slows down commits and mixes concerns.

## Proposed Reorganization

### Pre-commit: "Is the code safe to commit?" ⚡

**Focus:** Fast validation only (5-10 seconds)

**Keep in Pre-commit:**
```
✅ Code Validation
   - Linting (eslint)
   - TypeScript compilation
   - Unit tests (component-specific)
   - Cypress tests (component-specific)

✅ USWDS Compliance
   - Script tag presence
   - Layout forcing pattern
   - Component issue detection
   - Custom CSS validation
   - Icon name validation
   - Attribute mapping

✅ Code Quality
   - Test skip policy
   - Cypress test patterns
   - Component regression tests

✅ Integration Checks
   - USWDS transformation validation
   - Component JavaScript integration

✅ Documentation Validation (CHECK ONLY)
   - Documentation hygiene (categorization)
   - Documentation placeholders
   - Cross-reference validation
   - Check that component README exists
```

### Post-commit: "Update everything that depends on this code" 📝

**Focus:** Automated updates and cleanup (non-blocking)

**Move to Post-commit:**
```
📝 Documentation Generation
   - Storybook documentation sync ← MOVE FROM PRE-COMMIT
   - Bundle metrics updates ← MOVE FROM PRE-COMMIT
   - Documentation timestamps ← MOVE FROM PRE-COMMIT

📝 Component Documentation
   - Component changelogs (already post-commit)
   - README updates (already post-commit)
   - TESTING.md updates (already post-commit)

📝 Code Quality Feedback
   - AI code quality validation (already post-commit)
   - Code refactoring suggestions (already post-commit)

📝 Metrics & Reporting
   - Test coverage reports
   - Bundle size analysis
   - Performance metrics
```

## Implementation Steps

### Step 1: Split Documentation Sync Script

**Current:** `scripts/validate/validate-documentation-sync.cjs`

**Split into:**

1. **Pre-commit:** `scripts/validate/validate-documentation-check.cjs`
   ```javascript
   // VALIDATION ONLY - No file modifications
   // - Check component README exists
   // - Check CHANGELOG has unreleased section
   // - Validate cross-references
   // - Documentation hygiene
   // EXIT CODE: 0 = valid, 1 = invalid
   ```

2. **Post-commit:** `scripts/maintenance/update-documentation.cjs`
   ```javascript
   // UPDATES ONLY - Modify files
   // - Sync Storybook docs
   // - Update timestamps
   // - Update bundle metrics
   // - Create auto-commit if changes made
   ```

### Step 2: Update Pre-commit Hook

**File:** `scripts/validation/stages/06-final-validations.sh`

**Change:**
```bash
# BEFORE (Stage 11/11):
echo "📚 11/11 Documentation synchronization..."
node scripts/validate/validate-documentation-sync.cjs || exit 1

# AFTER (Stage 11/11):
echo "📚 11/11 Documentation validation..."
node scripts/validate/validate-documentation-check.cjs || exit 1
```

### Step 3: Update Post-commit Hook

**File:** `.husky/post-commit`

**Add:**
```bash
# Documentation Updates (non-blocking)
echo "📝 Post-commit: Updating documentation..."
node scripts/maintenance/update-documentation.cjs

# Stage and commit documentation updates if any
if ! git diff --quiet; then
  git add .storybook/*.mdx test-reports/*.json
  git commit --no-verify -m "docs: auto-update Storybook documentation and metrics

🤖 Generated by post-commit hook

Co-Authored-By: Claude <noreply@anthropic.com>"
fi
```

### Step 4: Configuration

Add environment variable to disable post-commit if needed:

```bash
# Disable post-commit documentation updates
SKIP_POST_COMMIT_DOCS=1 git commit -m "..."
```

## Expected Performance Improvement

### Current Pre-commit Timing
```
Repository organization:     0.5s
USWDS validation:           2.0s
Linting:                    5.4s
TypeScript:                 3.7s
Component unit tests:       2.2s
Cypress tests:             12.3s
Documentation sync:         8.5s  ← MOVE TO POST-COMMIT
Documentation validation:   1.0s
─────────────────────────────────
Total:                     35.6s
```

### Optimized Pre-commit Timing
```
Repository organization:     0.5s
USWDS validation:           2.0s
Linting:                    5.4s
TypeScript:                 3.7s
Component unit tests:       2.2s
Cypress tests:             12.3s
Documentation validation:   0.5s  ← FASTER (check only)
─────────────────────────────────
Total:                     26.6s  ← 9 seconds faster

Improvement: 25% faster commits
```

### Post-commit Timing (runs in background)
```
Documentation sync:         8.5s
Component changelogs:       1.0s
README updates:             0.5s
Bundle metrics:             2.0s
AI code quality:            3.0s
─────────────────────────────────
Total:                     15.0s  ← Runs after commit succeeds
```

## Benefits

### 1. Faster Commits ⚡
- 25% faster pre-commit (26s vs 36s)
- Developers spend less time waiting
- More likely to commit frequently

### 2. Better Separation of Concerns 🎯
- Pre-commit: "Can I commit this?" (validation)
- Post-commit: "What needs updating?" (cleanup)
- Clear mental model

### 3. Retry-Friendly 🔄
- If validation fails, no wasted doc generation
- Can retry commits faster
- Less frustration

### 4. Cleaner Git History 📚
```
commit abc123 - feat(button): add new variant
commit abc124 - docs: auto-update Storybook documentation

vs current:
commit abc123 - feat(button): add new variant
  (includes auto-generated doc changes mixed in)
```

### 5. Non-blocking Feedback 💬
- AI code quality runs post-commit (non-blocking)
- Get feedback without blocking progress
- Can address in next commit

### 6. Still Atomic 🔒
- Post-commit ensures docs always updated
- Can't forget to update docs
- Automated commit follows immediately

## Potential Concerns & Solutions

### Concern 1: "Docs might get out of sync"

**Solution:**
- Post-commit runs automatically (can't skip)
- Creates automatic commit if docs updated
- CI still sees updated docs

### Concern 2: "Two commits instead of one"

**Solution:**
- Actually cleaner git history
- Easy to see what was manual vs auto-generated
- Can squash on merge if needed

### Concern 3: "What if post-commit fails?"

**Solution:**
- Post-commit failures are non-blocking
- Warning message shown
- Can run manually: `npm run docs:update`
- Next commit will retry

### Concern 4: "CI might fail if docs not updated"

**Solution:**
- Post-commit runs before push
- CI sees both commits (code + docs)
- Can add CI check: `npm run validate:doc-sync`

## Rollback Plan

If issues arise:

```bash
# Disable post-commit doc updates
mv .husky/post-commit .husky/post-commit.disabled

# Revert to old pre-commit
git checkout HEAD~1 -- scripts/validation/stages/06-final-validations.sh
```

## Testing Plan

### Phase 1: Test on Non-critical Commits
1. Implement split scripts
2. Test on doc-only commits
3. Verify post-commit creates follow-up commit

### Phase 2: Test on Code Commits
1. Test on small component changes
2. Verify pre-commit faster
3. Verify post-commit updates docs correctly

### Phase 3: Test Edge Cases
1. Commit with validation failures
2. Commit with skip flags
3. Multiple rapid commits

## Migration Checklist

- [ ] Create `validate-documentation-check.cjs` (validation only)
- [ ] Create `update-documentation.cjs` (updates only)
- [ ] Update `06-final-validations.sh` (use check script)
- [ ] Update `.husky/post-commit` (add doc updates)
- [ ] Add `SKIP_POST_COMMIT_DOCS` support
- [ ] Test on sample commits
- [ ] Update documentation
- [ ] Announce to team

## Recommendation

**YES, this optimization makes sense!** ✅

The separation of validation (pre-commit) and cleanup (post-commit) is a best practice that:
- Improves developer experience (faster commits)
- Maintains quality (same validations)
- Ensures documentation stays updated (automatic)
- Provides better separation of concerns

**Suggested Timeline:**
1. Week 1: Implement and test split scripts
2. Week 2: Roll out to team
3. Week 3: Gather feedback and iterate

## Related Documentation

- Current pre-commit: `.husky/pre-commit`
- Current post-commit: `.husky/post-commit`
- Documentation sync: `scripts/validate/validate-documentation-sync.cjs`
- Storybook sync: `scripts/docs/sync-storybook-docs.js`

## Success Metrics

Track these metrics before/after:
- Average pre-commit time (target: <30s)
- Developer satisfaction (survey)
- Documentation accuracy (% up-to-date)
- Commit frequency (commits per day)

## Conclusion

This optimization aligns perfectly with the principle:
> **Pre-commit: Prevent bugs. Post-commit: Maintain quality.**

It's a smart architectural improvement that will make commits faster while keeping documentation automatically updated.

**Recommendation: Proceed with implementation** ✅
