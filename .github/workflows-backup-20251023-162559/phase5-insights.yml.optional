name: Phase 5 - AI Testing Insights

on:
  schedule:
    # Weekly insights report - Monday 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'scripts/smart-test-recommendations.js'
      - 'scripts/ai-test-generator.js'
      - 'scripts/chaos-engineering-tester.js'

jobs:
  ai-testing-insights:
    runs-on: ubuntu-latest
    name: ğŸ¤– AI Testing Insights & Recommendations

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§  Generate AI Test Analysis
        run: |
          echo "ğŸ¤– Running AI-powered test analysis..."
          npm run ai:analyze

      - name: ğŸ’¡ Generate Smart Test Recommendations
        run: |
          echo "ğŸ’¡ Generating comprehensive test recommendations..."
          npm run test:recommend:comprehensive

      - name: ğŸ”® Run Predictive Test Analysis
        run: |
          echo "ğŸ”® Analyzing test prediction capabilities..."
          npm run test:predict:dry-run --verbose

      - name: ğŸŒªï¸ Chaos Engineering Health Check
        run: |
          echo "ğŸŒªï¸ Running light chaos engineering health check..."
          npm run test:chaos:dry-run --intensity low

      - name: ğŸ“Š Generate Performance Insights
        run: |
          echo "ğŸ“Š Analyzing test performance optimization..."
          npm run test:optimize:dry-run

      - name: ğŸ“ˆ Upload Test Insights Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: phase5-insights-${{ github.sha }}
          path: |
            test-recommendations-report.json
            TEST_RECOMMENDATIONS.md
            chaos-engineering-report.json
            .predictive-test-results.json
          retention-days: 30

      - name: ğŸ’¬ Comment Insights Summary (PR only)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let comment = '## ğŸ¤– Phase 5 AI Testing Insights\n\n';

            // Add recommendations summary if file exists
            if (fs.existsSync('TEST_RECOMMENDATIONS.md')) {
              const recommendations = fs.readFileSync('TEST_RECOMMENDATIONS.md', 'utf8');
              const lines = recommendations.split('\n').slice(0, 20); // First 20 lines
              comment += '### ğŸ’¡ Test Recommendations\n\n';
              comment += lines.join('\n') + '\n\n';
              comment += '<details><summary>View Full Report</summary>\n\n';
              comment += 'Download the "phase5-insights" artifact for complete analysis.\n\n';
              comment += '</details>\n\n';
            }

            // Add chaos engineering summary if file exists
            if (fs.existsSync('chaos-engineering-report.json')) {
              try {
                const chaos = JSON.parse(fs.readFileSync('chaos-engineering-report.json', 'utf8'));
                comment += '### ğŸŒªï¸ Chaos Engineering\n\n';
                comment += `- **Scenarios**: ${chaos.summary?.totalScenarios || 0}\n`;
                comment += `- **Success Rate**: ${chaos.summary?.successRate || 0}%\n`;
                comment += `- **Recommendations**: ${chaos.recommendations?.length || 0}\n\n`;
              } catch (e) {
                comment += '### ğŸŒªï¸ Chaos Engineering\n\nReport available in artifacts.\n\n';
              }
            }

            comment += '---\n*Generated by Phase 5 AI Testing Infrastructure*';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  chaos-resilience-validation:
    runs-on: ubuntu-latest
    name: ğŸŒªï¸ Chaos Engineering Validation
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸŒªï¸ Run Chaos Engineering Tests
        run: |
          echo "ğŸŒªï¸ Running chaos engineering resilience tests..."
          npm run test:chaos:low --verbose

      - name: ğŸ“Š Upload Chaos Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chaos-engineering-results-${{ github.sha }}
          path: chaos-engineering-report.json
          retention-days: 7