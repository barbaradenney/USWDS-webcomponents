#!/usr/bin/env sh
# Husky post-commit hook for automatic changelog and testing documentation updates

# Get the latest commit hash and message
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%s)

# Skip if this commit was already generated by the post-commit hook to prevent infinite recursion
if echo "$COMMIT_MESSAGE" | grep -q "๐ค Generated by post-commit hook"; then
  echo "๐ Post-commit: Skipping hook-generated commit to prevent recursion"
  exit 0
fi

# Skip if this is a docs-only commit that doesn't affect components
if echo "$COMMIT_MESSAGE" | grep -q "^docs: update component changelogs"; then
  echo "๐ Post-commit: Skipping changelog-only commit"
  exit 0
fi

if echo "$COMMIT_MESSAGE" | grep -q "^docs: update component testing documentation"; then
  echo "๐ Post-commit: Skipping testing docs-only commit"
  exit 0
fi

if echo "$COMMIT_MESSAGE" | grep -q "^docs: update.*Storybook documentation"; then
  echo "๐ Post-commit: Skipping Storybook docs-only commit"
  exit 0
fi

if echo "$COMMIT_MESSAGE" | grep -q "^chore: archive obsolete documentation"; then
  echo "๐ Post-commit: Skipping doc cleanup commit"
  exit 0
fi

# Check for component file changes (for changelog updates)
COMPONENT_CHANGES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH | grep "^src/components/" | grep -v -E "(CHANGELOG\.md|TESTING\.md|\.docs\.mdx)" | wc -l)

# Check for test file changes (for testing documentation updates)
TEST_CHANGES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH | grep -E "\.(test|cy|stories)\.ts$" | wc -l)

# Check for documentation file changes (for Storybook docs updates)
DOCS_CHANGES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH | grep -E "(README\.md|CHANGELOG\.md|TESTING\.md)$" | wc -l)

# Skip if no relevant changes
if [ "$COMPONENT_CHANGES" -eq 0 ] && [ "$TEST_CHANGES" -eq 0 ] && [ "$DOCS_CHANGES" -eq 0 ]; then
  echo "๐ Post-commit: No component, test, or documentation file changes detected, skipping updates"
  exit 0
fi

CHANGELOG_UPDATED=false
README_UPDATED=false

# Update changelogs if component files changed
if [ "$COMPONENT_CHANGES" -gt 0 ]; then
  echo "๐ Post-commit: Updating component changelogs for $COMPONENT_CHANGES component file changes..."
  node scripts/maintenance/manage-changelogs.js process-commit "$COMMIT_HASH" "$COMMIT_MESSAGE"
  
  if ! git diff --quiet --exit-code src/components/*/CHANGELOG.md 2>/dev/null; then
    echo "๐ Changelogs updated"
    CHANGELOG_UPDATED=true
  fi
fi

# Update README files if component files changed
if [ "$COMPONENT_CHANGES" -gt 0 ]; then
  echo "๐ Post-commit: Updating component README files for $COMPONENT_CHANGES component file changes..."
  node scripts/maintenance/manage-readmes.js process-commit "$COMMIT_HASH" "$COMMIT_MESSAGE"
  
  if ! git diff --quiet --exit-code src/components/*/README.md 2>/dev/null; then
    echo "๐ README files updated"
    README_UPDATED=true
  fi
fi

TESTING_DOCS_UPDATED=false

# Update testing docs if test files changed
if [ "$TEST_CHANGES" -gt 0 ]; then
  echo "๐ Post-commit: Updating testing documentation for $TEST_CHANGES test file changes..."
  node scripts/maintenance/manage-testing-docs.js process-commit "$COMMIT_HASH" "$COMMIT_MESSAGE"

  if ! git diff --quiet --exit-code src/components/*/TESTING.md 2>/dev/null; then
    echo "๐ Testing docs updated"
    TESTING_DOCS_UPDATED=true
  fi
fi

# Note: Automatic Storybook documentation generation has been disabled
echo "๐ Storybook documentation generation is disabled"

# Commit any documentation updates
if [ "$CHANGELOG_UPDATED" = true ] || [ "$README_UPDATED" = true ] || [ "$TESTING_DOCS_UPDATED" = true ]; then
  echo "๐ Staging documentation changes..."

  # Stage any updated documentation files
  if [ "$CHANGELOG_UPDATED" = true ]; then
    git add src/components/*/CHANGELOG.md
  fi

  if [ "$README_UPDATED" = true ]; then
    git add src/components/*/README.md
  fi

  if [ "$TESTING_DOCS_UPDATED" = true ]; then
    git add src/components/*/TESTING.md
  fi

  # Create commit message based on what was updated
  if [ "$CHANGELOG_UPDATED" = true ] && [ "$README_UPDATED" = true ] && [ "$TESTING_DOCS_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component documentation"
    DETAILS="Automatically updated changelogs, READMEs, and testing docs for changes in commit: $COMMIT_HASH"
  elif [ "$CHANGELOG_UPDATED" = true ] && [ "$README_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component changelogs and READMEs"
    DETAILS="Automatically updated changelogs and READMEs for components affected by commit: $COMMIT_HASH"
  elif [ "$CHANGELOG_UPDATED" = true ] && [ "$TESTING_DOCS_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component changelogs and testing documentation"
    DETAILS="Automatically updated changelogs and testing docs for changes in commit: $COMMIT_HASH"
  elif [ "$README_UPDATED" = true ] && [ "$TESTING_DOCS_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component READMEs and testing documentation"
    DETAILS="Automatically updated READMEs and testing docs for changes in commit: $COMMIT_HASH"
  elif [ "$CHANGELOG_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component changelogs"
    DETAILS="Automatically updated changelogs for components affected by commit: $COMMIT_HASH"
  elif [ "$README_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component READMEs"
    DETAILS="Automatically updated READMEs for components affected by commit: $COMMIT_HASH"
  elif [ "$TESTING_DOCS_UPDATED" = true ]; then
    COMMIT_MSG="docs: update component testing documentation"
    DETAILS="Automatically updated testing docs for test file changes in commit: $COMMIT_HASH"
  fi
  
  # Create a follow-up commit for documentation updates (avoid infinite loop with --no-verify)
  git commit --no-verify -m "$COMMIT_MSG

$DETAILS

๐ค Generated by post-commit hook"
  
  echo "โ Component documentation updated and committed"
else
  echo "โ No documentation updates needed"
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Automated Documentation Cleanup
# Runs cleanup if many docs are ready for archive (configurable threshold)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# Skip if disabled via environment variable
if [ "$SKIP_DOC_CLEANUP" = "1" ]; then
  echo "๐ Post-commit: Documentation cleanup skipped (SKIP_DOC_CLEANUP=1)"
else
  # Skip if this is already a doc cleanup commit
  if echo "$COMMIT_MESSAGE" | grep -q "^chore: archive obsolete documentation"; then
    echo "๐ Post-commit: Skipping doc cleanup-only commit"
  else
    # Check how many docs are ready for archive
    ARCHIVABLE_COUNT=$(node scripts/maintenance/cleanup-documentation.cjs --dry-run 2>/dev/null | grep "๐ฆ Archivable:" | awk '{print $3}')

    if [ -n "$ARCHIVABLE_COUNT" ] && [ "$ARCHIVABLE_COUNT" -gt 5 ]; then
      echo ""
      echo "๐งน Post-commit: Found $ARCHIVABLE_COUNT docs ready for archive"
      echo "   Running automated cleanup..."

      # Run cleanup
      node scripts/maintenance/cleanup-documentation.cjs

      # Check if any files were actually moved
      if ! git diff --quiet --exit-code docs/ 2>/dev/null; then
        echo "๐ฆ Staging archived documentation..."
        git add docs/

        # Create automatic cleanup commit
        git commit --no-verify -m "chore: archive obsolete documentation

Automatically archived $ARCHIVABLE_COUNT obsolete doc(s) via post-commit hook.
Threshold: 5 docs ready for archive.

To disable: SKIP_DOC_CLEANUP=1 git commit

๐ค Generated by post-commit hook"

        echo "โ Documentation cleanup completed and committed"
      else
        echo "โ No documentation changes after cleanup"
      fi
    elif [ -n "$ARCHIVABLE_COUNT" ] && [ "$ARCHIVABLE_COUNT" -gt 0 ]; then
      echo "๐ Post-commit: Found $ARCHIVABLE_COUNT doc(s) ready for archive (threshold: 5)"
      echo "   Run manually: npm run docs:cleanup"
    fi
  fi
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Discovered Issues Policy Enforcement
# See: CLAUDE.md - Discovered Issues Policy
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# Check if the last commit message mentions --no-verify
if echo "$COMMIT_MESSAGE" | grep -q -i "no-verify"; then
  echo ""
  echo "๐จ Detected --no-verify commit"
  echo "๐ Generating discovered issues tracker..."
  echo ""

  # Run the discovered issues generator
  node scripts/validate/generate-discovered-issues.cjs

  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
  echo "โ๏ธ  IMPORTANT: Fix discovered issues before starting new work"
  echo ""
  echo "๐ See: CLAUDE.md - Discovered Issues Policy"
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# AI Code Quality Validation (Post-Commit - Non-Blocking)
# Moved from pre-commit to prevent false positives from blocking commits
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo ""
echo "๐ค Running AI code quality validation (informational)..."
echo ""

# Run AI quality validation
if node scripts/validate/ai-code-quality-validator.cjs 2>&1 | tee /tmp/ai-quality-report.txt; then
  echo ""
  echo "โ No AI code quality issues detected"
else
  echo ""
  echo "โ๏ธ  AI Code Quality Issues Found (non-blocking)"
  echo ""
  cat /tmp/ai-quality-report.txt
  echo ""
  echo "๐ก These issues don't block your commit but should be addressed:"
  echo "   โข Remove console.log statements"
  echo "   โข Clean up debugging code"
  echo "   โข Add cleanup to event listeners/timers"
  echo "   โข Use specific error messages"
  echo ""
  echo "๐ See: docs/AI_CODE_QUALITY_GUIDE.md"
  echo ""
fi

rm -f /tmp/ai-quality-report.txt

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Automated Code Cleanup (Opt-In)
# Environment variables to enable:
#   AUTO_FIX_LINT=1      - Auto-fix ESLint errors
#   AUTO_FORMAT=1        - Auto-format with Prettier
#   AUTO_CLEANUP_CACHE=1 - Clear stale caches
#   AUTO_CLEANUP=1       - Enable all cleanup features
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

CLEANUP_PERFORMED=false

# Check if any cleanup is enabled
if [ "$AUTO_CLEANUP" = "1" ] || [ "$AUTO_FIX_LINT" = "1" ] || [ "$AUTO_FORMAT" = "1" ] || [ "$AUTO_CLEANUP_CACHE" = "1" ]; then
  echo ""
  echo "๐งน Post-commit: Running automated cleanup..."
  echo ""
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 1. ESLint Auto-Fix
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if [ "$AUTO_CLEANUP" = "1" ] || [ "$AUTO_FIX_LINT" = "1" ]; then
  echo "๐ง ESLint Auto-Fix: Fixing auto-fixable linting errors..."

  # Get modified TypeScript/JavaScript files from the last commit
  MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH | grep -E '\.(ts|tsx|js|jsx)$' | grep -v node_modules || true)

  if [ -n "$MODIFIED_FILES" ]; then
    # Run ESLint with --fix on modified files
    echo "$MODIFIED_FILES" | xargs npx eslint --fix --quiet || true

    # Check if any files were modified
    if ! git diff --quiet --exit-code; then
      echo "  โ Auto-fixed linting errors"
      git add .
      CLEANUP_PERFORMED=true
      LINT_FIXED=true
    else
      echo "  โน๏ธ  No auto-fixable linting errors found"
    fi
  else
    echo "  โน๏ธ  No TypeScript/JavaScript files modified"
  fi

  echo ""
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 2. Prettier Auto-Format
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if [ "$AUTO_CLEANUP" = "1" ] || [ "$AUTO_FORMAT" = "1" ]; then
  echo "๐จ Prettier Auto-Format: Ensuring consistent code formatting..."

  # Get modified files from the last commit (exclude generated files)
  MODIFIED_FILES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH | grep -E '\.(ts|tsx|js|jsx|css|scss|json|md)$' | grep -v -E '(node_modules|dist|build|coverage|\.next)' || true)

  if [ -n "$MODIFIED_FILES" ]; then
    # Run Prettier with --write on modified files
    echo "$MODIFIED_FILES" | xargs npx prettier --write --ignore-unknown || true

    # Check if any files were modified
    if ! git diff --quiet --exit-code; then
      echo "  โ Auto-formatted code with Prettier"
      git add .
      CLEANUP_PERFORMED=true
      PRETTIER_FORMATTED=true
    else
      echo "  โน๏ธ  Code already properly formatted"
    fi
  else
    echo "  โน๏ธ  No formattable files modified"
  fi

  echo ""
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# 3. Cache Cleanup
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if [ "$AUTO_CLEANUP" = "1" ] || [ "$AUTO_CLEANUP_CACHE" = "1" ]; then
  echo "๐งน Cache Cleanup: Removing stale caches..."

  SPACE_FREED=0

  # Clear node_modules/.cache
  if [ -d "node_modules/.cache" ]; then
    CACHE_SIZE=$(du -sk node_modules/.cache | cut -f1)
    rm -rf node_modules/.cache
    SPACE_FREED=$((SPACE_FREED + CACHE_SIZE))
    echo "  โ Cleared node_modules/.cache ($(echo "scale=2; $CACHE_SIZE/1024" | bc)MB)"
  fi

  # Clear Storybook cache
  if [ -d "node_modules/.cache/storybook" ]; then
    SB_CACHE_SIZE=$(du -sk node_modules/.cache/storybook 2>/dev/null | cut -f1 || echo "0")
    rm -rf node_modules/.cache/storybook
    SPACE_FREED=$((SPACE_FREED + SB_CACHE_SIZE))
    echo "  โ Cleared Storybook cache ($(echo "scale=2; $SB_CACHE_SIZE/1024" | bc)MB)"
  fi

  # Clear Vite cache
  if [ -d "node_modules/.vite" ]; then
    VITE_CACHE_SIZE=$(du -sk node_modules/.vite 2>/dev/null | cut -f1 || echo "0")
    rm -rf node_modules/.vite
    SPACE_FREED=$((SPACE_FREED + VITE_CACHE_SIZE))
    echo "  โ Cleared Vite cache ($(echo "scale=2; $VITE_CACHE_SIZE/1024" | bc)MB)"
  fi

  if [ "$SPACE_FREED" -gt 0 ]; then
    echo "  ๐พ Total space freed: $(echo "scale=2; $SPACE_FREED/1024" | bc)MB"
    CACHE_CLEANED=true
  else
    echo "  โน๏ธ  No caches to clean"
  fi

  echo ""
fi

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Commit Cleanup Changes
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

if [ "$CLEANUP_PERFORMED" = true ]; then
  echo "๐ Committing automated cleanup changes..."

  # Build commit message based on what was cleaned
  CLEANUP_MSG="chore: automated code cleanup"
  CLEANUP_DETAILS=""

  if [ "$LINT_FIXED" = true ]; then
    CLEANUP_DETAILS="${CLEANUP_DETAILS}- Auto-fixed ESLint errors\n"
  fi

  if [ "$PRETTIER_FORMATTED" = true ]; then
    CLEANUP_DETAILS="${CLEANUP_DETAILS}- Auto-formatted code with Prettier\n"
  fi

  if [ "$CACHE_CLEANED" = true ]; then
    CLEANUP_DETAILS="${CLEANUP_DETAILS}- Cleared stale caches\n"
  fi

  # Create cleanup commit
  git commit --no-verify -m "$CLEANUP_MSG

Automated cleanup performed post-commit:
$CLEANUP_DETAILS
Original commit: $COMMIT_HASH

To disable: SKIP_AUTO_CLEANUP=1 git commit

๐ค Generated by post-commit hook"

  echo "โ Cleanup changes committed"
  echo ""
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo "๐ Post-commit cleanup summary:"
  if [ "$LINT_FIXED" = true ]; then
    echo "  โ ESLint errors auto-fixed"
  fi
  if [ "$PRETTIER_FORMATTED" = true ]; then
    echo "  โ Code auto-formatted"
  fi
  if [ "$CACHE_CLEANED" = true ]; then
    echo "  โ Caches cleaned"
  fi
  echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
  echo ""
fi