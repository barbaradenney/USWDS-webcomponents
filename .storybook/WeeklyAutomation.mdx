import { Meta } from '@storybook/blocks';

<Meta title="Documentation/Weekly Automation" />

# Weekly Automation & Scheduled Maintenance

> **Auto-generated on:** 2025-10-19
> This documentation is automatically updated during the pre-commit process.

## Overview

The USWDS Web Components library employs comprehensive weekly automation through GitHub Actions to maintain code quality, security, performance, and documentation without manual intervention. These scheduled workflows run automatically, create issues when problems are detected, and often create automated pull requests for review.

## 🎯 Goals

### Continuous Quality
- **Weekly intensive testing** - Flaky tests, mutation, contracts, performance
- **Automated dependency updates** - Patch, minor, and security updates
- **USWDS update monitoring** - Detect new USWDS releases automatically
- **Documentation maintenance** - Keep docs current and organized

### Proactive Problem Detection
- **Find issues early** - Before they reach production
- **Auto-create GitHub issues** - Track problems automatically
- **Detailed reports** - Comprehensive diagnostics
- **Actionable recommendations** - Clear next steps

### Zero Manual Work
- **Fully automated** - No manual intervention required
- **Scheduled execution** - Runs during low-traffic times
- **Auto-create PRs** - Dependency updates ready for review
- **Self-maintaining** - Documentation stays current

## 📅 Weekly Schedule

### Monday 9:00 AM UTC

**1. Documentation Maintenance**
- Validate documentation consistency
- Check for outdated docs
- Sync component documentation status
- Check for broken links
- Auto-cleanup obsolete docs
- Commit updated documentation

**2. Dependency Updates**
- Check for outdated dependencies
- Security audit
- Auto-update patch/minor versions
- Run comprehensive tests
- Create PRs for dependency updates
- Create urgent PRs for security fixes

### Monday 2:00 PM UTC (9 AM EST)

**3. USWDS Update Monitor**
- Check for new USWDS releases
- Fetch release notes
- Analyze CSS changes
- Create test branch
- Run compatibility tests
- Create GitHub issue with action items

### Sunday 3:00 AM UTC

**4. Weekly Intensive Testing**
- Flaky test detection (10 runs)
- Mutation testing
- Contract testing
- Performance regression tracking
- Create GitHub issues for problems

## 🔄 Automation Details

### 1. Documentation Maintenance

**Schedule:** Every Monday at 9 AM UTC
**Workflow:** `.github/workflows/docs-maintenance.yml`

**What It Does:**

#### Stage 1: Documentation Validation
```bash
🔍 Validating documentation consistency...
  ✅ Component READMEs complete
  ✅ CHANGELOG files present
  ✅ Storybook docs aligned
  ✅ USWDS references valid
```

#### Stage 2: Outdated Documentation Check
```bash
📅 Checking for outdated documentation...
  ⚠️ Found 2 docs not updated in 90+ days
  📋 Generating outdated docs report...
```

#### Stage 3: Component Status Sync
```bash
📊 Syncing component documentation status...
  Total components: 45
  Complete (90%+): 45
  In Progress (50-89%): 0
  Needs Work (<50%): 0

  ✅ docs/component-status-report.md updated
  ✅ docs/COMPONENT_REVIEW_STATUS.md updated
```

#### Stage 4: Link Check
```bash
🔗 Checking documentation links...
  Total links checked: 342
  Broken links found: 0
  ✅ All links valid
```

#### Stage 5: Automated Cleanup

Only runs weekly (not on every push):

```bash
🧹 Running automated weekly documentation cleanup...

📊 Analyzing documentation state...
  Found 6 docs ready for archive

🗑️ Archiving obsolete documentation...
  TEMPORARY docs (7+ days old): 4
  STATUS docs (60+ days old): 2

📦 Creating archive structure...
  docs/archive/2025-10/

✅ Documentation cleanup completed

# Auto-commits:
chore: automated weekly documentation cleanup

Archived 6 obsolete doc(s).

Automated by GitHub Actions (weekly schedule).

🤖 Generated by docs-maintenance workflow
```

**Outputs:**
- Updated component status reports
- Documentation health report
- GitHub issue if broken links found
- Automatic commit with cleaned documentation

### 2. Dependency Updates

**Schedule:** Every Monday at 9 AM UTC
**Workflow:** `.github/workflows/dependency-updates.yml`

**What It Does:**

#### Stage 1: Dependency Check
```bash
🔍 Checking for outdated dependencies...

  Found 12 packages that can be updated:

  @storybook/web-components-vite: 9.1.10 → 9.2.0
  typescript: 5.0.2 → 5.3.0
  vitest: 3.2.4 → 3.3.0
  ...
```

#### Stage 2: Security Audit
```bash
🔒 Running security audit...

  ⚠️ Found 2 security vulnerabilities

  Vulnerabilities:
  - axios: moderate (SSRF vulnerability)
  - semver: high (Regular Expression Denial of Service)

  Running npm audit fix...
```

#### Stage 3: Automated Updates

Creates **two separate PRs** (one for each update type):

**PR 1: Patch Updates**
```bash
🔄 Updating patch dependencies...

  Branch: deps/automated-patch-updates

  Updates:
  - vitest: 3.2.4 → 3.2.5
  - @playwright/test: 1.55.0 → 1.55.1
  - typescript: 5.0.2 → 5.0.4

  ✅ Running tests to ensure updates don't break functionality...
  ✅ Unit tests: Passed
  ✅ Type checking: Passed
  ✅ Linting: Passed

  📦 Creating PR: "🤖 Automated patch dependency updates"
```

**PR 2: Minor Updates**
```bash
🔄 Updating minor dependencies...

  Branch: deps/automated-minor-updates

  Updates:
  - @storybook/web-components-vite: 9.1.10 → 9.2.0
  - typescript: 5.0.4 → 5.3.0

  ✅ Running tests to ensure updates don't break functionality...
  ✅ Unit tests: Passed
  ✅ Type checking: Passed
  ✅ Linting: Passed

  📦 Creating PR: "🤖 Automated minor dependency updates"
```

#### Stage 4: Security Updates (Urgent)

If vulnerabilities found, creates **urgent PR**:

```bash
🔒 Applying security fixes...

  Branch: security/automated-security-fixes

  Fixed 2 vulnerabilities:
  - axios: moderate (SSRF vulnerability)
  - semver: high (Regular Expression Denial of Service)

  ✅ Running tests to ensure fixes don't break functionality...
  ✅ All tests passing

  🚨 Creating URGENT PR: "🔒 URGENT: Automated security vulnerability fixes"

  Labels: security, urgent, automated
```

**Outputs:**
- Up to 3 PRs: patch updates, minor updates, security fixes
- Comprehensive test results
- Bundle size impact analysis
- Workflow summary

**Example PR Body:**
```markdown
## 📦 Dependency Updates (patch)

### Changed Dependencies:
\`\`\`diff
- "vitest": "^3.2.4"
+ "vitest": "^3.2.5"
- "@playwright/test": "^1.55.0"
+ "@playwright/test": "^1.55.1"
\`\`\`

### Testing Results:
- ✅ Unit tests: Passed
- ✅ Type checking: Passed
- ✅ Linting: Passed
- ✅ Bundle analysis: Completed

🤖 Automated dependency updates for patch versions
```

### 3. USWDS Update Monitor

**Schedule:** Every Monday at 2:00 PM UTC (9 AM EST)
**Workflow:** `.github/workflows/uswds-update-check.yml`

**What It Does:**

#### Stage 1: Version Check
```bash
🔍 Checking for USWDS updates...

  Current USWDS version: ^3.13.0
  Latest USWDS version: 3.14.0

  🔄 USWDS update available: 3.13.0 → 3.14.0
```

#### Stage 2: Release Notes Analysis
```bash
📝 Fetching USWDS release notes...

  Analyzing release notes for v3.14.0...

  Checking for breaking changes:
  - Found keyword: "breaking"
  - Found keyword: "migration"

  ⚠️ Breaking changes detected!
```

#### Stage 3: CSS Changes Analysis
```bash
🎨 Analyzing CSS changes...

  Downloading USWDS v3.14.0...
  Extracting package...

  ### New CSS Files:
  - packages/usa-new-component/src/styles/_usa-new-component.scss

  ### Modified Components:
  - usa-accordion (class changes detected)
  - usa-button (new variant added)
```

#### Stage 4: Create Test Branch
```bash
🔧 Creating test branch with USWDS update...

  Branch: uswds-update-v3.14.0

  Installing @uswds/uswds@3.14.0...
  Running build to check for immediate issues...

  ✅ Build completed successfully

  Committing changes:
  "chore(deps): update @uswds/uswds to v3.14.0"
```

#### Stage 5: Compatibility Tests
```bash
🧪 Running compatibility tests...

  Linting: ✅ Passed
  Type Checking: ⚠️ Found 2 type errors
  Unit Tests: ✅ Passed (2301/2301)

  Saving test results...
```

#### Stage 6: Create GitHub Issue

Automatically creates detailed issue:

```markdown
# 🔄 USWDS Update Available: v3.14.0

**Current Version:** ^3.13.0
**Latest Version:** 3.14.0
**Breaking Changes:** ⚠️ Yes

## 📋 Action Items

- [ ] Review release notes below
- [ ] Check CSS compatibility analysis
- [ ] Run visual regression tests
- [ ] Test component functionality
- [ ] Update component tests if needed
- [ ] Verify accessibility compliance
- [ ] Update documentation if needed

## 📝 Release Notes

[Full USWDS v3.14.0 release notes from GitHub]

## 🎨 CSS Changes Analysis

### New CSS Files:
- packages/usa-new-component/src/styles/_usa-new-component.scss

### Modified Components:
- usa-accordion (class changes detected)
- usa-button (new variant added)

## 🧪 Compatibility Test Results

- Linting: ✅ Passed
- Type Checking: ❌ Failed (2 errors)
- Unit Tests: ✅ Passed

## 🚀 Next Steps

1. Review the automated test branch: `uswds-update-v3.14.0`
2. Run comprehensive tests locally
3. Create PR when ready to merge
4. Close this issue after successful update

---

*This issue was automatically created by the USWDS Update Monitor workflow.*
```

**Assignee:** barbaramiles
**Labels:** uswds-update, dependencies, breaking-change

**Outputs:**
- GitHub issue with complete analysis
- Test branch with USWDS update
- Compatibility test results
- CSS changes analysis
- Release notes summary

### 4. Weekly Intensive Testing

**Schedule:** Every Sunday at 3:00 AM UTC
**Workflow:** `.github/workflows/weekly-intensive-testing.yml`

**What It Does:**

#### Test 1: Flaky Test Detection

Runs each test 10 times to identify instability:

```bash
🔍 Running flaky test detection (10 runs)...

  Running test suite 10 times...

  Run 1: ✅ Passed (2301/2301)
  Run 2: ✅ Passed (2301/2301)
  Run 3: ❌ Failed (2300/2301) - usa-modal.test.ts
  Run 4: ✅ Passed (2301/2301)
  Run 5: ❌ Failed (2300/2301) - usa-modal.test.ts
  Run 6: ✅ Passed (2301/2301)
  Run 7: ✅ Passed (2301/2301)
  Run 8: ✅ Passed (2301/2301)
  Run 9: ✅ Passed (2301/2301)
  Run 10: ✅ Passed (2301/2301)

  🚨 Found 1 flaky test:

  Test: "should close modal on overlay click"
  File: src/components/modal/usa-modal.test.ts
  Pass Rate: 80% (8/10)
  Pattern: ✓✓✗✓✗✓✓✓✓✓
```

**Creates GitHub Issue:**
```markdown
## 🔍 Flaky Tests Detected

**Summary:**
- Total test runs: 10
- Flaky tests found: 1
- Date: 2025-10-19T03:00:00Z

**Flaky Tests:**

1. **should close modal on overlay click**
   - File: `src/components/modal/usa-modal.test.ts`
   - Pass Rate: 80% (8/10)
   - Pattern: ✓✓✗✓✗✓✓✓✓✓

**Recommendations:**
1. Review test patterns for timing issues
2. Check for race conditions
3. Add proper waits/assertions
4. Consider quarantining until fixed

📄 Full report available in workflow artifacts.
```

#### Test 2: Mutation Testing

Tests the quality of your tests by introducing bugs:

```bash
🧬 Running mutation testing...

  Installing Stryker mutation testing...
  Generating mutations...

  Mutations tested: 1,245
  Mutations killed: 1,012 (81.3%)
  Mutations survived: 233 (18.7%)
  Mutations timed out: 0

  Mutation Score: 81.3%
```

**If score < 80%, creates GitHub Issue:**
```markdown
## 🧬 Low Mutation Testing Score

**Current Mutation Score: 78.5%**
**Target: 80%+**

The mutation testing score is below the recommended threshold. This indicates that your tests may not be catching all potential bugs.

**What This Means:**
- 78.5% of code mutations were detected by tests
- 21.5% of mutations survived (bugs that tests didn't catch)

**Recommendations:**
1. Review survived mutants in the HTML report
2. Add missing test cases
3. Improve assertion specificity
4. Test edge cases more thoroughly

📄 View detailed report in workflow artifacts.
```

#### Test 3: Contract Testing

Validates component APIs haven't changed unexpectedly:

```bash
📜 Running contract testing...

  Checking for baseline contracts...
  Baseline found: test-contracts/component-contracts.json

  Validating component contracts...

  ✅ accordion: API contract valid
  ✅ alert: API contract valid
  ⚠️ button: Property 'size' type changed (string → number)
  ✅ modal: API contract valid
  ...

  Summary:
  - Total components: 45
  - Passed: 44
  - Changed: 1 (button)
```

**If contracts missing, creates PR with baseline.**

#### Test 4: Performance Regression

Tracks performance over time:

```bash
⚡ Running performance regression tracking...

  Starting Storybook...
  Installing Playwright...

  Checking for baseline: performance-reports/baseline.json
  Baseline found.

  Running performance tests...

  Component: accordion
    Render time: 45ms (baseline: 42ms, +7%)
    Memory: 512KB (baseline: 498KB, +2.8%)

  Component: button
    Render time: 15ms (baseline: 14ms, +7%)
    Memory: 245KB (baseline: 240KB, +2%)

  Component: modal
    Render time: 125ms (baseline: 95ms, +31%)  🚨 REGRESSION!
    Memory: 892KB (baseline: 825KB, +8%)

  ⚠️ Performance regression detected in 1 component
```

**Creates GitHub Issue if regressions found:**
```markdown
## ⚡ Performance Regression Detected

Performance has degraded compared to the baseline.

**Metrics:**
- modal render time: 95ms → 125ms (+31%)
- Threshold exceeded: >20% regression

**Recommendations:**
1. Profile the modal component
2. Review recent changes to modal
3. Check for unnecessary re-renders
4. Optimize or update baseline if acceptable

📄 Full performance report available in workflow artifacts.
```

#### Summary
```bash
📊 Weekly Intensive Testing Summary

## Test Results

| Test Type | Status |
|-----------|--------|
| 🔍 Flaky Detection | success |
| 🧬 Mutation Testing | success |
| 📜 Contract Testing | success |
| ⚡ Performance Regression | failure |

📅 Scheduled run: Every Sunday at 3 AM UTC
🔄 Next run: 2025-10-26 03:00 UTC
```

**Outputs:**
- Flaky test report (JSON)
- Mutation testing report (HTML)
- Contract test results
- Performance regression reports
- GitHub issues for any failures

## 📊 Manual Triggering

All workflows support manual triggering via `workflow_dispatch`:

### Documentation Maintenance
```bash
# Go to GitHub Actions → Documentation Maintenance → Run workflow
# Triggers immediately
```

### Dependency Updates
```bash
# Go to GitHub Actions → Automated Dependency Updates → Run workflow
# Choose update type: patch | minor | major | all
```

### USWDS Update Monitor
```bash
# Go to GitHub Actions → USWDS Update Monitor → Run workflow
# Checks for USWDS updates immediately
```

### Weekly Intensive Testing
```bash
# Go to GitHub Actions → Weekly Intensive Testing → Run workflow

# Options:
# - Run flaky test detection: true/false
# - Run mutation testing: true/false
# - Run contract testing: true/false
# - Run performance regression: true/false
# - Number of runs for flaky detection: 1-20
```

## 🔔 Notifications

### GitHub Issues Created

Workflows automatically create GitHub issues for:

1. **Broken Documentation Links** (docs-maintenance)
   - Labels: documentation, automated, maintenance
   - Assignee: none

2. **Flaky Tests Detected** (weekly-intensive-testing)
   - Labels: testing, flaky-test, needs-investigation
   - Includes: Test names, pass rates, patterns

3. **Low Mutation Score** (weekly-intensive-testing)
   - Labels: testing, mutation-testing, needs-improvement
   - Threshold: < 80%

4. **Performance Regression** (weekly-intensive-testing)
   - Labels: performance, regression, needs-investigation
   - Threshold: > 20% degradation

5. **USWDS Update Available** (uswds-update-monitor)
   - Labels: uswds-update, dependencies, [breaking-change if applicable]
   - Assignee: barbaramiles
   - Includes: Release notes, CSS analysis, test results

### Pull Requests Created

Workflows automatically create PRs for:

1. **Patch Dependency Updates** (dependency-updates)
   - Branch: `deps/automated-patch-updates`
   - Labels: dependencies, automated
   - All tests must pass before PR creation

2. **Minor Dependency Updates** (dependency-updates)
   - Branch: `deps/automated-minor-updates`
   - Labels: dependencies, automated
   - All tests must pass before PR creation

3. **Security Vulnerability Fixes** (dependency-updates)
   - Branch: `security/automated-security-fixes`
   - Labels: security, urgent, automated
   - **URGENT - Review immediately**

4. **Component Contract Baseline** (weekly-intensive-testing)
   - Branch: `contracts/add-baseline`
   - Labels: testing, contracts, auto-generated
   - Only if baseline missing

### Workflow Artifacts

All workflows upload artifacts for detailed analysis:

- **documentation-report** (docs-maintenance, 30 days)
- **flaky-test-report** (weekly-intensive-testing, 30 days)
- **mutation-test-report** (weekly-intensive-testing, 30 days)
- **contract-test-report** (weekly-intensive-testing, 30 days)
- **performance-reports** (weekly-intensive-testing, 30 days)

## 📈 Benefits

### For Developers

**No Manual Maintenance:**
- Dependencies update automatically
- Tests run weekly
- Issues created for problems
- Documentation stays current

**Early Problem Detection:**
- Flaky tests found before they cause CI failures
- Performance regressions caught early
- Security vulnerabilities fixed immediately
- USWDS updates tracked automatically

**Clear Action Items:**
- GitHub issues with detailed reports
- Recommendations for fixes
- Links to artifacts for investigation
- Assigned to appropriate team members

### For the Project

**Continuous Quality:**
- 81%+ mutation testing score
- 0 known flaky tests
- All dependencies current
- Security vulnerabilities fixed within hours

**Proactive Maintenance:**
- USWDS updates detected within hours
- Dependency updates weekly
- Documentation cleanup automatic
- Performance tracking continuous

**Risk Mitigation:**
- Breaking changes identified early
- Compatibility tested before merge
- Security fixes applied immediately
- Performance regressions caught

### For Users

**Always Current:**
- Latest USWDS features available
- Security vulnerabilities fixed quickly
- Dependencies kept up to date
- Documentation accurate

**High Quality:**
- Thoroughly tested
- Performance monitored
- API stability tracked
- Accessibility maintained

## 🚨 Troubleshooting

### Workflow Failed - Documentation Maintenance

**Check:**
```bash
# View workflow logs
gh run view <run-id> --log

# Common issues:
# - Broken links (check link-check stage)
# - Git conflicts (check commit stage)
# - Script errors (check individual stages)
```

**Fix:**
```bash
# If link check fails:
pnpm run validate:image-links

# If cleanup fails:
pnpm run docs:cleanup:dry-run

# If commit fails:
git pull origin main
pnpm run docs:sync
```

### Workflow Failed - Dependency Updates

**Check:**
```bash
# View failed stage
gh run view <run-id> --log

# Common issues:
# - Tests fail after update
# - Type errors from new version
# - Breaking changes in dependency
```

**Fix:**
```bash
# Reproduce locally:
pnpm add <package>@<version>
pnpm test
pnpm run typecheck

# Fix issues, then:
git commit -m "fix: resolve issues from <package> update"
```

### Workflow Failed - USWDS Update Monitor

**Check:**
```bash
# Review the created GitHub issue
# Check compatibility test results in artifacts

# Common issues:
# - Breaking changes in new USWDS version
# - CSS class changes
# - Component structure changes
```

**Fix:**
```bash
# Checkout the test branch:
git fetch origin
git checkout uswds-update-v<version>

# Run full compliance:
pnpm run uswds:sync
pnpm run validate:uswds-compliance

# Fix any issues:
# - Update component code
# - Update tests
# - Update documentation
```

### Workflow Failed - Weekly Intensive Testing

**Check which test failed:**
```bash
# View workflow summary
gh run view <run-id>

# Download artifacts:
gh run download <run-id>
```

**Flaky Tests:**
```bash
# Run locally to reproduce:
pnpm run test:flaky-detection -- --runs=10 --verbose

# Fix the flaky test:
# - Add proper waits
# - Fix race conditions
# - Improve assertions
```

**Mutation Testing:**
```bash
# View HTML report in artifacts
# Add missing test cases
pnpm run test:mutation
```

**Contract Testing:**
```bash
# Check what changed:
pnpm run test:contracts:validate -- --verbose

# Update contracts if intentional:
pnpm run test:contracts:generate
```

**Performance Regression:**
```bash
# Profile the slow component:
pnpm run test:performance:compare

# Review recent changes to component
# Optimize or update baseline if acceptable
```

## ⚡ Turborepo Integration

### Monorepo Performance Benefits

**Weekly automation tasks benefit from Turborepo's remote caching:**

**Build Performance:**
```bash
# Without cache (first run)
pnpm run build  # ~39s

# With remote cache (subsequent runs)
pnpm run build  # ~0.35s (111x faster!)
```

**Test Performance:**
```bash
# All packages test in parallel
pnpm test  # Turborepo runs tests across 11 packages simultaneously
```

### Automated Tasks with Turborepo

**Dependency Updates:**
```yaml
- name: Build all packages (with cache)
  run: pnpm run build
  env:
    TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
    TURBO_TEAM: ${{ secrets.TURBO_TEAM }}
```

**Flaky Test Detection:**
```bash
# Each package's tests run independently
# Failed packages don't block successful ones
# Turborepo caches passing test results
```

**Performance Benefits:**
- ✅ **10x faster CI runs** - Weekly automation completes in minutes, not hours
- ✅ **Parallel execution** - All 11 packages process simultaneously
- ✅ **Smart caching** - Skip unchanged packages entirely
- ✅ **Cost reduction** - Less GitHub Actions minutes consumed

## 📚 Related Documentation

- [Post-Commit System](./PostCommitSystem.mdx) - Automatic documentation updates
- [USWDS Sync System](./USWDSSync.mdx) - USWDS class list updates
- [CI/CD Pipeline](./CICDPipeline.mdx) - Complete testing infrastructure with Turborepo

---

**The Weekly Automation system, powered by Turborepo and pnpm workspaces, ensures continuous quality, security, and maintenance without manual intervention - detecting problems early, creating actionable issues, and keeping the project healthy automatically with unprecedented performance.**
