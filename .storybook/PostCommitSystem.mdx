import { Meta } from '@storybook/blocks';

<Meta title="Documentation/Post-Commit System" />

# Post-Commit Automation System

> **Auto-generated on:** 2025-10-19
> This documentation is automatically updated during the pre-commit process.

## Overview

The USWDS Web Components library employs an intelligent post-commit automation system that runs after every commit to maintain documentation freshness, enforce quality policies, and prevent technical debt accumulation. This system operates seamlessly in the background to keep all documentation synchronized with code changes.

## ğŸ¯ Goals

### Documentation Freshness
- **Auto-update changelogs** - Component changes automatically logged
- **Sync README files** - Component documentation stays current
- **Update testing docs** - Test changes reflected in documentation
- **Zero manual maintenance** - Documentation updates happen automatically

### Quality Enforcement
- **Discovered issues tracking** - Issues found during `--no-verify` commits must be fixed
- **Documentation hygiene** - Obsolete docs automatically archived
- **Prevent debt accumulation** - Issues can't be ignored or forgotten
- **Enforce fix workflow** - No new work until discovered issues resolved

### Developer Experience
- **Zero overhead** - Runs automatically, no manual intervention
- **Intelligent detection** - Only updates what changed
- **Prevents loops** - Smart recursion detection
- **Clear feedback** - Informative output at each step

## ğŸ”„ Post-Commit Automation Stages

### Stage 1: Change Detection
**Purpose:** Identify what type of changes were made in the commit

**Detection Logic:**
```bash
# Detect component file changes
COMPONENT_CHANGES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH |
  grep "^src/components/" |
  grep -v -E "(CHANGELOG\.md|TESTING\.md|\.docs\.mdx)" |
  wc -l)

# Detect test file changes
TEST_CHANGES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH |
  grep -E "\.(test|cy|stories)\.ts$" |
  wc -l)

# Detect documentation changes
DOCS_CHANGES=$(git diff-tree --no-commit-id --name-only -r $COMMIT_HASH |
  grep -E "(README\.md|CHANGELOG\.md|TESTING\.md)$" |
  wc -l)
```

**Triggers:**
- Component files changed â†’ Update CHANGELOGs and READMEs
- Test files changed â†’ Update TESTING.md
- Documentation changed â†’ Update Storybook docs (currently disabled)

### Stage 2: Automatic CHANGELOG Updates
**Purpose:** Maintain version history for every component

**When It Runs:**
- Component TypeScript files modified
- Component styles modified
- Component behavior changed

**What It Does:**
```bash
# Analyze commit and update changelogs
node scripts/maintenance/manage-changelogs.js process-commit "$COMMIT_HASH" "$COMMIT_MESSAGE"

# Example CHANGELOG entry generated:
## [Unreleased]

### Changed
- Updated button component with new variant support
- Commit: abc123 - feat(button): add outline variant
```

**Intelligent Detection:**
- Parses commit message for conventional commits
- Identifies affected components
- Categorizes changes (Added, Changed, Fixed, etc.)
- Maintains proper Keep a Changelog format

### Stage 3: Automatic README Updates
**Purpose:** Keep component documentation synchronized with implementation

**When It Runs:**
- Component properties added/changed
- Component events added/changed
- Component methods added/changed

**What It Does:**
```bash
# Update README files with latest API
node scripts/maintenance/manage-readmes.js process-commit "$COMMIT_HASH" "$COMMIT_MESSAGE"

# Updates sections:
- Properties table
- Events table
- Methods table
- Usage examples
- Accessibility features
```

**Smart Updates:**
- Extracts property info from TypeScript decorators
- Documents event types from dispatch calls
- Maintains existing examples and descriptions
- Preserves custom documentation sections

### Stage 4: Testing Documentation Updates
**Purpose:** Keep test documentation current with test implementation

**When It Runs:**
- Test files created/modified
- Cypress tests added/changed
- Story files updated

**What It Does:**
```bash
# Update TESTING.md files
node scripts/maintenance/manage-testing-docs.js process-commit "$COMMIT_HASH" "$COMMIT_MESSAGE"

# Documents:
- Test coverage status
- Test file locations
- Testing approach
- Known testing issues
```

**Coverage Tracking:**
- Unit test status
- Component test status
- Accessibility test status
- Visual regression test status

### Stage 5: Automated Documentation Cleanup
**Purpose:** Prevent documentation accumulation and maintain organization

**When It Runs:**
- After every commit (unless disabled)
- When 5+ documents ready for archive

**What It Does:**
```bash
# Check archivable doc count
ARCHIVABLE_COUNT=$(node scripts/maintenance/cleanup-documentation.cjs --dry-run)

# If count > 5, automatically archive
if [ "$ARCHIVABLE_COUNT" -gt 5 ]; then
  node scripts/maintenance/cleanup-documentation.cjs
  git add docs/
  git commit -m "chore: archive obsolete documentation"
fi
```

**Archive Categories:**
- **TEMPORARY docs** â†’ Archived after 7 days
- **STATUS docs** â†’ Archived after 60 days
- **PERMANENT docs** â†’ Never archived

**Example:**
```
Before:
docs/
â”œâ”€â”€ BUTTON_INVESTIGATION_2025_10_01.md (temp, 8 days old)
â”œâ”€â”€ TEST_FAILURE_ANALYSIS_2025_09_15.md (status, 35 days old)
â””â”€â”€ ARCHITECTURE_PATTERNS.md (permanent)

After automatic cleanup:
docs/
â”œâ”€â”€ ARCHITECTURE_PATTERNS.md (permanent)
â””â”€â”€ archive/
    â””â”€â”€ 2025-10/
        â”œâ”€â”€ BUTTON_INVESTIGATION_2025_10_01.md
        â””â”€â”€ TEST_FAILURE_ANALYSIS_2025_09_15.md
```

### Stage 6: Discovered Issues Policy Enforcement
**Purpose:** Ensure issues found during `--no-verify` commits get fixed

**When It Runs:**
- When commit message contains "no-verify"
- When `--no-verify` flag was used

**What It Does:**
```bash
# Generate .git/DISCOVERED_ISSUES.json tracker
node scripts/validate/generate-discovered-issues.cjs

# Example tracker file:
{
  "commit": "abc123",
  "timestamp": "2025-10-19T12:00:00Z",
  "message": "fix(header): add aria-label",
  "issues": [
    {
      "type": "validation_failure",
      "file": "src/components/character-count/usa-character-count.ts",
      "description": "Missing USWDS JS integration"
    }
  ]
}
```

**Enforcement:**
- Next pre-commit hook checks for tracker file
- If exists, **blocks all new commits** until issues fixed
- Tracker auto-deletes when validation passes
- Prevents ignoring validation failures

### Stage 7: AI Code Quality Validation (Post-Commit - Non-Blocking)
**Purpose:** Detect common AI code generation anti-patterns without blocking commits

**When It Runs:**
- After every commit (moved from pre-commit to prevent false positives)
- Provides informational feedback only

**What It Does:**
```bash
# Run AI quality validation (non-blocking)
node scripts/validate/ai-code-quality-validator.cjs

# Detects common AI anti-patterns:
# - console.log/debugger statements
# - Event listeners without cleanup
# - setInterval/setTimeout without cleanup
# - Generic error messages
# - Over-commenting
# - Magic numbers without constants
# - Deep nesting (4+ levels)
```

**Why Post-Commit?**
- Pre-existing code can trigger false positives
- Doesn't block valid commits
- Provides feedback for cleanup in next commit
- Better developer experience

**What It Detects:**
```typescript
// âŒ Errors (should fix):
console.log('debugging'); // Left in code
element.addEventListener('click', handler); // No cleanup in disconnectedCallback
const timer = setInterval(...); // No clearInterval

// âš ï¸ Warnings (suggestions):
// This function adds two numbers together (obvious comment)
const veryLongDescriptiveVariableName = ...; // >20 chars
if (foo) { if (bar) { if (baz) { if (qux) { } } } } // 4+ levels
```

**Output:**
```
ğŸ¤– Running AI code quality validation (informational)...

âš ï¸  AI Code Quality Issues Found (non-blocking)

ğŸ’¡ These issues don't block your commit but should be addressed:
   â€¢ Remove console.log statements
   â€¢ Clean up debugging code
   â€¢ Add cleanup to event listeners/timers
   â€¢ Use specific error messages

ğŸ“– See: docs/AI_CODE_QUALITY_GUIDE.md
```

### Stage 8: Automated Code Cleanup (Opt-In)
**Purpose:** Automatically clean up code after commits (optional feature)

**When It Runs:**
- Only when enabled via environment variables
- After all other post-commit stages complete

**Environment Variables:**
```bash
# Enable all cleanup features
AUTO_CLEANUP=1 git commit -m "feat: add feature"

# Enable individual features
AUTO_FIX_LINT=1 git commit -m "feat: add feature"        # ESLint auto-fix
AUTO_FORMAT=1 git commit -m "feat: add feature"          # Prettier format
AUTO_CLEANUP_CACHE=1 git commit -m "feat: add feature"   # Cache cleanup

# Disable cleanup for one commit
SKIP_AUTO_CLEANUP=1 git commit -m "feat: add feature"
```

**Feature 1: ESLint Auto-Fix**
```bash
# Automatically fix auto-fixable linting errors
echo "$MODIFIED_FILES" | xargs npx eslint --fix --quiet

# Example fixes:
# - Missing semicolons
# - Incorrect spacing
# - Import order
# - Unused variables (some cases)
```

**Feature 2: Prettier Auto-Format**
```bash
# Automatically format code with Prettier
echo "$MODIFIED_FILES" | xargs npx prettier --write --ignore-unknown

# Formats:
# - TypeScript/JavaScript files
# - CSS/SCSS files
# - JSON files
# - Markdown files
```

**Feature 3: Cache Cleanup**
```bash
# Clear stale caches to free disk space
rm -rf node_modules/.cache
rm -rf node_modules/.cache/storybook
rm -rf node_modules/.vite

# Tracks space freed:
Total space freed: 66.47MB
```

**Automatic Commit:**
```bash
# If cleanup made changes, creates automatic commit
git commit --no-verify -m "chore: automated code cleanup

Automated cleanup performed post-commit:
- Auto-fixed ESLint errors
- Auto-formatted code with Prettier
- Cleared stale caches

Original commit: abc123

To disable: SKIP_AUTO_CLEANUP=1 git commit

ğŸ¤– Generated by post-commit hook"
```

**Benefits:**
- **Zero manual effort** - Cleanup happens automatically
- **Consistent formatting** - All code follows same style
- **Clean caches** - Frees disk space automatically
- **Optional** - Only runs when enabled

**Example Workflow:**
```bash
# 1. Enable cleanup for your session
export AUTO_CLEANUP=1

# 2. Make changes and commit
git commit -m "feat(button): add new variant"

# POST-COMMIT runs:
# âœ… Documentation updates
# âœ… AI quality validation (informational)
# âœ… ESLint auto-fix
# âœ… Prettier formatting
# âœ… Cache cleanup
# âœ… Creates cleanup commit

# 3. Git history shows:
# abc123 - feat(button): add new variant
# def456 - docs: update component changelogs ğŸ¤–
# ghi789 - chore: automated code cleanup ğŸ¤–
```

## ğŸ“Š Recursion Prevention

The post-commit hook includes intelligent recursion detection to prevent infinite loops:

### Detection Methods

**1. Commit Message Markers:**
```bash
# Skip hook-generated commits
if echo "$COMMIT_MESSAGE" | grep -q "ğŸ¤– Generated by post-commit hook"; then
  exit 0
fi
```

**2. Commit Type Detection:**
```bash
# Skip documentation-only commits
if echo "$COMMIT_MESSAGE" | grep -q "^docs: update component changelogs"; then
  exit 0
fi

# Skip cleanup commits
if echo "$COMMIT_MESSAGE" | grep -q "^chore: archive obsolete documentation"; then
  exit 0
fi
```

**3. --no-verify Flag:**
```bash
# All auto-commits use --no-verify
git commit --no-verify -m "docs: update component changelogs

ğŸ¤– Generated by post-commit hook"
```

## ğŸš« Common Post-Commit Scenarios

### 1. Component File Changed

**Scenario:**
```bash
git commit -m "feat(button): add new variant"
```

**Post-Commit Actions:**
```
ğŸ”„ Post-commit: Updating component changelogs for 1 component file changes...
ğŸ“ Changelogs updated
ğŸ“– Post-commit: Updating component README files for 1 component file changes...
ğŸ“– README files updated
ğŸ“ Staging documentation changes...
âœ… Component documentation updated and committed

# Automatic commit created:
docs: update component changelogs and READMEs

Automatically updated changelogs and READMEs for components affected by commit: abc123

ğŸ¤– Generated by post-commit hook
```

### 2. Test File Changed

**Scenario:**
```bash
git commit -m "test(alert): add accessibility tests"
```

**Post-Commit Actions:**
```
ğŸ“‹ Post-commit: Updating testing documentation for 1 test file changes...
ğŸ“‹ Testing docs updated
ğŸ“ Staging documentation changes...
âœ… Component documentation updated and committed

# Automatic commit created:
docs: update component testing documentation

Automatically updated testing docs for test file changes in commit: def456

ğŸ¤– Generated by post-commit hook
```

### 3. Using --no-verify

**Scenario:**
```bash
git commit --no-verify -m "fix(header): add aria-label

Note: Used --no-verify due to pre-existing validation failure
in character-count. Will fix next."
```

**Post-Commit Actions:**
```
ğŸš¨ Detected --no-verify commit
ğŸ“‹ Generating discovered issues tracker...

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âš ï¸  IMPORTANT: Fix discovered issues before starting new work

ğŸ“– See: CLAUDE.md - Discovered Issues Policy
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Creates .git/DISCOVERED_ISSUES.json
# Next commit will be blocked until issues fixed
```

### 4. Documentation Cleanup Triggered

**Scenario:**
```bash
# After multiple commits, 6 docs are ready for archive
git commit -m "feat(modal): improve accessibility"
```

**Post-Commit Actions:**
```
ğŸ”„ Post-commit: Updating component changelogs...
âœ… Component documentation updated and committed

ğŸ§¹ Post-commit: Found 6 docs ready for archive
   Running automated cleanup...
ğŸ“¦ Staging archived documentation...
âœ… Documentation cleanup completed and committed

# Two automatic commits created:
1. docs: update component changelogs
2. chore: archive obsolete documentation
```

## ğŸ› ï¸ Configuration

### Disable Documentation Cleanup
```bash
# Temporarily disable for one commit
SKIP_DOC_CLEANUP=1 git commit -m "feat: add component"

# Set environment variable for session
export SKIP_DOC_CLEANUP=1
```

### Adjust Cleanup Threshold
Edit `.husky/post-commit`:
```bash
# Change threshold from 5 to 10
if [ "$ARCHIVABLE_COUNT" -gt 10 ]; then
  node scripts/maintenance/cleanup-documentation.cjs
fi
```

### Hook Location
Post-commit hook: `.husky/post-commit`

### Scripts Called
- `scripts/maintenance/manage-changelogs.js` - CHANGELOG updates
- `scripts/maintenance/manage-readmes.js` - README updates
- `scripts/maintenance/manage-testing-docs.js` - TESTING.md updates
- `scripts/maintenance/cleanup-documentation.cjs` - Documentation cleanup
- `scripts/validate/generate-discovered-issues.cjs` - Issue tracking

## ğŸ“ˆ Benefits

### For Developers
- **No manual docs** - Changelogs and READMEs auto-update
- **No doc debt** - Obsolete docs automatically cleaned
- **Clear accountability** - Discovered issues must be fixed
- **Zero overhead** - Everything happens automatically

### For the Project
- **Always current** - Documentation never drifts from code
- **Clean repository** - No documentation accumulation
- **Quality enforcement** - Can't bypass validation permanently
- **Audit trail** - Complete history of all changes

### For Users
- **Accurate docs** - Documentation matches current code
- **Complete history** - Every change documented in changelogs
- **Reliable testing info** - Test docs stay current
- **Professional quality** - Well-maintained documentation

## ğŸ”„ Workflow Example

**Complete workflow showing pre-commit and post-commit interaction:**

```bash
# 1. Make changes to button component
vim src/components/button/usa-button.ts

# 2. Commit changes
git commit -m "feat(button): add danger variant"

# PRE-COMMIT runs:
# âœ… Repository organization
# âœ… USWDS compliance
# âœ… Code quality
# âœ… TypeScript compilation
# âœ… All 13 validation stages pass
# âœ… Commit allowed

# POST-COMMIT runs:
# ğŸ”„ Detects: 1 component file changed
# ğŸ“ Updates: src/components/button/CHANGELOG.md
# ğŸ“– Updates: src/components/button/README.md
# âœ… Creates automatic commit:
#    "docs: update component changelogs and READMEs"

# 3. Git history now shows:
# abc123 - feat(button): add danger variant
# def456 - docs: update component changelogs and READMEs ğŸ¤–

# 4. Documentation is automatically current!
```

## âš ï¸ Important Notes

### Recursion Safety
The post-commit hook is designed to **never cause infinite loops**:
- Recognizes its own commits
- Skips documentation-only commits
- Uses `--no-verify` for auto-commits
- Has multiple safety checks

### Discovered Issues Enforcement
When you use `--no-verify`:
1. Post-commit creates `.git/DISCOVERED_ISSUES.json`
2. Next pre-commit **blocks all new work**
3. You **must** fix the issues first
4. Once fixed, tracker auto-deletes
5. Normal development resumes

**This prevents the pattern of:**
```bash
# Bad workflow (prevented):
git commit --no-verify -m "quick fix"  # Issues discovered
git commit -m "new feature"            # âŒ BLOCKED!

# Good workflow (enforced):
git commit --no-verify -m "quick fix"  # Issues discovered
git commit -m "fix: resolve issues"    # âœ… Must fix first
git commit -m "new feature"            # âœ… Now allowed
```

### Manual Overrides
If post-commit is causing issues:
```bash
# Temporarily disable all hooks
git commit --no-verify -m "emergency fix"

# Disable just doc cleanup
SKIP_DOC_CLEANUP=1 git commit -m "feat: add feature"
```

## ğŸ”§ Troubleshooting

### Post-Commit Runs on Every Commit
**Expected behavior** - This is by design. The hook intelligently determines what to do based on file changes.

### Automatic Commits Appearing
**Expected behavior** - Documentation updates create automatic follow-up commits. This keeps docs separate from feature commits.

### DISCOVERED_ISSUES.json Blocking Commits
**Expected behavior** - Fix the discovered issues before proceeding. See `CLAUDE.md` - Discovered Issues Policy.

### Documentation Cleanup Too Aggressive
```bash
# Adjust threshold in .husky/post-commit
if [ "$ARCHIVABLE_COUNT" -gt 10 ]; then  # Was 5
  node scripts/maintenance/cleanup-documentation.cjs
fi
```

## ğŸ“š Related Documentation

- [Pre-Commit System](./PreCommitSystem.mdx) - Validation that runs before commits
- [Documentation Lifecycle](../docs/DOCUMENTATION_LIFECYCLE.md) - Complete doc management guide
- [CLAUDE.md](../CLAUDE.md) - Discovered Issues Policy

---

**The post-commit system ensures documentation stays synchronized with code changes automatically, enforces quality policies, and prevents technical debt accumulation - all without developer intervention.**
