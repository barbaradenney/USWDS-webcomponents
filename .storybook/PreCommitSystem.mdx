import { Meta } from '@storybook/blocks';

<Meta title="Documentation/Pre-Commit System" />

# Pre-Commit Validation System

> **Auto-generated on:** 2025-10-20
> This documentation is automatically updated during the pre-commit process.

## Overview

The USWDS Web Components library employs an extensive pre-commit validation system that runs **13 automated checks** before every commit. This system prevents regressions, enforces code quality, and ensures 100% USWDS compliance.

## üéØ Goals

### Quality Assurance
- **Prevent regressions** - Catch issues before they reach the repository
- **Enforce standards** - Maintain consistent code quality and architecture
- **Validate compliance** - Ensure USWDS alignment doesn't drift
- **Protect users** - No broken code ever reaches production

### Developer Confidence
- **Fast feedback** - Issues caught immediately, not in CI
- **Clear errors** - Specific, actionable error messages
- **Auto-fix capable** - Many issues automatically corrected
- **Comprehensive coverage** - All aspects of code quality checked

## üîç Pre-Commit Validation Stages

### Stage 1: Repository Organization
**Purpose:** Ensure clean, maintainable codebase structure

**Checks:**
1. **Repository Cleanup** - Remove stale files and directories
2. **Script Organization** - Validate script directory structure
3. **Documentation Sync** - Ensure docs are up-to-date

**Auto-fixes:**
- Removes orphaned test files
- Deletes duplicate story files
- Cleans up obsolete scripts

### Stage 2: USWDS Compliance Validation
**Purpose:** Maintain 100% USWDS alignment

**Checks:**
1. **Script Tag Validation** - Verify USWDS loaded globally
2. **CSS Class Validation** - Ensure only approved USWDS classes
3. **JavaScript Pattern Validation** - Check USWDS integration patterns
4. **Component Structure Validation** - Verify USWDS DOM structure

**Validation Rules:**
```typescript
// REQUIRED: USWDS script tag in preview-head.html
<script src="/node_modules/@uswds/uswds/dist/js/uswds.min.js"></script>

// REQUIRED: Components use initializeUSWDSComponent()
override firstUpdated(changedProperties: Map<string, any>) {
  super.firstUpdated(changedProperties);
  this.initializeUSWDSComponent();
}

// PROHIBITED: Custom CSS beyond :host display styles
:host {
  display: block; /* ‚úÖ Allowed */
}
.custom-style { /* ‚ùå Prohibited */
  color: red;
}
```

### Stage 3: Code Quality Checks
**Purpose:** Enforce TypeScript and JavaScript standards

**Checks:**
1. **TypeScript Compilation** - Full type checking
2. **ESLint Validation** - Code quality rules
3. **Prettier Formatting** - Consistent code style
4. **Import Validation** - Verify all imports resolve

**Auto-fixes:**
- Prettier auto-formats code
- ESLint fixes simple violations
- Import statements organized

**Example Checks:**
```typescript
// ‚úÖ Correct: Type-safe property
@property({ type: String }) label!: string;

// ‚ùå Error: Missing type annotation
@property() label; // TypeScript error

// ‚úÖ Correct: Proper event typing
this.dispatchEvent(new CustomEvent<{value: string}>('change', {
  detail: { value: this.value }
}));

// ‚ùå Error: Untyped event
this.dispatchEvent(new CustomEvent('change')); // Missing detail type
```

### Stage 4: Layout & Rendering Validation
**Purpose:** Ensure proper Storybook and component rendering

**Checks:**
1. **Layout Forcing Pattern** - Verify Storybook layout recalculation
2. **Story Styles Validation** - Check story inline styles
3. **Component Registration** - Validate all components registered

**Layout Forcing Validation:**
```typescript
// REQUIRED in .storybook/preview.ts
const forceLayoutRecalculation = (): void => {
  const storybookRoot = document.getElementById('storybook-root');
  if (!storybookRoot) return;

  const originalDisplay = storybookRoot.style.display;
  storybookRoot.style.display = 'none';
  void storybookRoot.offsetHeight; // Force reflow
  storybookRoot.style.display = originalDisplay || '';
  void storybookRoot.offsetHeight; // Force reflow again
};
```

### Stage 5: Component Issue Detection
**Purpose:** Identify and prevent common component problems

**Checks:**
1. **Double Initialization Prevention** - Ensure no duplicate USWDS init
2. **Event Handler Validation** - Check proper event binding
3. **Accessibility Validation** - Verify ARIA attributes
4. **Slot Content Validation** - Validate Light DOM slots

**Double Initialization Check:**
```typescript
// ‚úÖ Correct: Guard against double initialization
private isUSWDSInitialized = false;

protected initializeUSWDSComponent() {
  if (this.isUSWDSInitialized) return;
  this.isUSWDSInitialized = true;

  // Safe to initialize USWDS
}

// ‚ùå Error: No guard - may initialize twice
protected initializeUSWDSComponent() {
  // Direct initialization - dangerous!
}
```

### Stage 6: Test Validation
**Purpose:** Ensure comprehensive test coverage

**Checks:**
1. **Test Existence** - Every component has tests
2. **Test Coverage** - Minimum coverage thresholds met
3. **Test Expectations** - Tests match USWDS behavior
4. **Accessibility Tests** - axe-core validation included

**Required Test Structure:**
```typescript
describe('USAComponent', () => {
  // ‚úÖ Required: Basic rendering
  it('should render', () => { ... });

  // ‚úÖ Required: Property tests
  it('should handle property changes', () => { ... });

  // ‚úÖ Required: Event tests
  it('should emit events', () => { ... });

  // ‚úÖ Required: Accessibility tests
  it('should be accessible', async () => {
    await expect(element).toBeAccessible();
  });

  // ‚úÖ Required: USWDS compliance
  it('should match USWDS structure', () => { ... });
});
```

### Stage 7: USWDS Transformation Validation
**Purpose:** Verify USWDS DOM transformations work correctly

**Checks:**
1. **Transformation Pattern Detection** - Identify transformation components
2. **DOM Structure Validation** - Check transformed output
3. **JavaScript Integration** - Verify USWDS behavior attached

**Transformation Components:**
- Modal (moves to body)
- Date Picker (creates calendar UI)
- Combo Box (creates dropdown list)
- Time Picker (creates time selection)
- Tooltip (positions dynamically)
- Header (mobile menu transformation)

### Stage 8: Documentation Validation
**Purpose:** Ensure documentation stays current

**Checks:**
1. **Component README Existence** - Every component documented
2. **Changelog Sync** - Version history up-to-date
3. **API Documentation** - Properties/events/methods documented
4. **Storybook Sync** - This documentation auto-updated

**Auto-Generated Documentation:**
```bash
# Updates these docs automatically
npm run docs:sync

# Auto-generated files:
- .storybook/About.mdx
- .storybook/PreCommitSystem.mdx
- .storybook/CICDPipeline.mdx
- .storybook/BundleOptimization.mdx
- .storybook/USWDSCompliance.mdx
```

### Stage 9: Component-Specific Validation
**Purpose:** Handle unique component requirements

**Checks:**
1. **Language Selector Validation** - Story styles and USWDS compliance
2. **High-Risk Component Checks** - Extra validation for complex components
3. **Form Component Validation** - Form integration requirements

**Example: Language Selector:**
```bash
# Special validation for modified components
MODIFIED_COMPONENTS="language-selector" npm run validate:story-styles
MODIFIED_COMPONENTS="language-selector" node scripts/validate/validate-uswds-compliance.cjs
```

### Stage 10: Code Quality Architectural Review
**Purpose:** Prevent over-engineering and ensure architectural consistency

**Checks:**
1. **USWDS Pattern Detection** - Verify correct integration approach
2. **Over-Engineering Detection** - Flag unnecessary complexity
3. **Architecture Alignment** - Check adherence to design decisions

**Architectural Rules:**
```typescript
// ‚úÖ Correct: Simple USWDS integration
protected initializeUSWDSComponent() {
  if (window.USWDS?.accordion) {
    window.USWDS.accordion.on(this);
  }
}

// ‚ùå Over-Engineered: Custom re-implementation
protected initializeUSWDSComponent() {
  // 200 lines of custom accordion logic
  // DON'T REINVENT USWDS!
}
```

## üìä Validation Metrics

### Speed
- **Average Runtime:** 15-30 seconds
- **Parallel Execution:** Most checks run concurrently
- **Incremental:** Only checks affected files when possible
- **Cached:** Reuses previous results when applicable

### Coverage
- **Code Coverage:** 2301+ tests covering all components
- **Accessibility Coverage:** 100% of components tested with axe-core
- **USWDS Compliance:** 100% validation across all 46 components
- **Documentation Coverage:** Every component fully documented

### Error Detection
- **TypeScript Errors:** 100% caught before commit
- **USWDS Violations:** 100% caught before commit
- **Accessibility Issues:** 100% caught before commit
- **Architectural Drift:** 100% caught before commit

## üö´ Common Pre-Commit Failures

### 1. USWDS Script Tag Missing
**Error:**
```
‚ùå USWDS script tag validation failed!
The USWDS <script> tag is missing from .storybook/preview-head.html
```

**Fix:**
```html
<!-- Add to .storybook/preview-head.html -->
<script src="/node_modules/@uswds/uswds/dist/js/uswds.min.js"></script>
```

### 2. Unauthorized CSS Classes
**Error:**
```
‚ùå Component uses unauthorized CSS classes!
Found non-USWDS class: .custom-button-style
```

**Fix:**
```typescript
// ‚ùå Remove custom CSS
.custom-button-style { color: red; }

// ‚úÖ Use USWDS classes
className="usa-button usa-button--secondary"
```

### 3. Missing Tests
**Error:**
```
‚ùå Component src/components/button/usa-button.ts has no tests!
```

**Fix:**
```bash
# Create test file
touch src/components/button/usa-button.test.ts

# Or use generator
npm run generate:component -- --name=button
```

### 4. Double Initialization
**Error:**
```
‚ùå Component may initialize USWDS multiple times!
Missing initialization guard
```

**Fix:**
```typescript
// Add guard
private isUSWDSInitialized = false;

protected initializeUSWDSComponent() {
  if (this.isUSWDSInitialized) return;
  this.isUSWDSInitialized = true;
  // ... initialization code
}
```

### 5. Layout Forcing Missing
**Error:**
```
‚ùå Storybook layout forcing not detected!
```

**Fix:**
```typescript
// Add to .storybook/preview.ts decorator
decorators: [
  (story) => {
    cleanupUSWDSElements();
    forceLayoutRecalculation(); // ‚Üê Add this
    return story();
  },
],
```

## üõ†Ô∏è Bypassing Pre-Commit (Emergency Only)

**Warning:** Only use in emergencies when pre-commit is broken!

```bash
# Skip pre-commit hooks (NOT RECOMMENDED)
git commit --no-verify -m "Emergency fix"

# Better: Fix the validation issue
npm run validate:fix  # Auto-fix what's possible
npm run validate      # Re-run validation
```

## üîß Configuration

### Hook Configuration
Pre-commit hooks configured in `.husky/pre-commit`:

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 1. Repository organization cleanup
node scripts/ci/cleanup-validator.cjs || exit 1

# 2. Script organization validation
node scripts/validate/validate-script-organization.js || exit 1

# 3. USWDS script tag validation
node scripts/validate/validate-uswds-script-tag.js || exit 1

# 4. Layout forcing pattern validation
node scripts/validate/validate-layout-forcing.js || exit 1

# 5. Component issue detection
node scripts/validate/auto-detect-component-issues.js || exit 1

# 6. USWDS compliance validation
node scripts/validate/validate-uswds-compliance.cjs || exit 1

# 7. Lint validation
npm run lint || exit 1

# 8. TypeScript compilation
npm run typecheck || exit 1

# 9. Code quality review
node scripts/validate/code-quality-review.cjs || exit 1

# 10. Component-specific validation (language-selector)
MODIFIED_COMPONENTS="language-selector" npm run validate:story-styles
MODIFIED_COMPONENTS="language-selector" node scripts/validate/validate-uswds-compliance.cjs

# 11. Test expectations validation
node scripts/test/regression-test-validator.js || exit 1

# 12. USWDS transformation validation
node scripts/validate-uswds-transformation.js || exit 1

# 13. Component JavaScript integration
node scripts/validate/validate-component-javascript.js || exit 1

# 14. Documentation synchronization
node scripts/docs/sync-storybook-docs.js || exit 1

# Lint-staged (file-specific validation)
npx lint-staged
```

### Selective Validation
For faster iteration, run specific checks:

```bash
# Run just TypeScript check
npm run typecheck

# Run just linting
npm run lint

# Run just USWDS compliance
npm run validate:uswds

# Run all validation
npm run validate
```

## üìà Benefits

### For Developers
- **Immediate Feedback** - Know about issues instantly
- **Prevents Wasted Time** - No waiting for CI to find issues
- **Learning Tool** - Understand standards through validation
- **Confidence** - Know your code meets standards before pushing

### For the Project
- **Zero Regressions** - Prevents quality decay over time
- **Consistent Quality** - All code meets same standards
- **Documentation Current** - Docs always match implementation
- **USWDS Alignment** - Compliance never drifts

### For Users
- **Reliable Components** - Every commit fully validated
- **Accessibility Guaranteed** - Can't commit inaccessible code
- **USWDS Compliant** - Components always match official USWDS
- **Well Documented** - Docs automatically stay current

## üîÑ Continuous Improvement

The pre-commit system evolves based on:
- **Regression Analysis** - New checks added when issues found
- **Developer Feedback** - Checks refined based on pain points
- **USWDS Updates** - Validation updated with new USWDS releases
- **Best Practices** - Industry standards incorporated

---

**The pre-commit system is the first line of defense ensuring every commit maintains the highest standards of quality, accessibility, and USWDS compliance.**
